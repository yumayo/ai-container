#!/bin/bash

aicontainer() {
  mkdir -p .claude.local
  [ ! -f .claude.local/.claude.json ] && echo '{}' > .claude.local/.claude.json || true
  mkdir -p .claude.local/.claude

  # .aiignoreの各行を読み込んでtmpfsマウントや/dev/nullにマウントすることで、機密情報へのアクセスをブロックします。
  AI_IGNORE=""
  if [ -f .aiignore ]; then
    while IFS= read -r line || [ -n "$line" ]; do
      # CRLF対応: 行末のCR(\r)を削除
      line="${line%$'\r'}"

      if [ -n "$line" ] && [[ ! "$line" =~ ^[[:space:]]*# ]]; then
        line="${line#/}"
        if [ -d "$line" ]; then
          AI_IGNORE="$AI_IGNORE --mount type=tmpfs,target=/workspace/$line,tmpfs-size=0"
        elif [ -f "$line" ]; then
          AI_IGNORE="$AI_IGNORE --mount type=bind,source=/dev/null,target=/workspace/$line,readonly"
        fi
        echo ignored. $line
      fi
    done < .aiignore
  fi

  # .aimountの各行を読み込んで追加のマウントコマンドを作成します。
  # フォーマット: src:dst (コロン区切り、改行コード区切り)
  AI_MOUNT=""
  if [ -f .aimount ]; then
    while IFS= read -r line || [ -n "$line" ]; do
      # CRLF対応: 行末のCR(\r)を削除
      line="${line%$'\r'}"

      if [ -n "$line" ] && [[ ! "$line" =~ ^[[:space:]]*# ]]; then
        # コロンで分割
        IFS=':' read -r src dst <<< "$line"

        if [ -n "$src" ] && [ -n "$dst" ]; then
          # srcが相対パスの場合は絶対パスに変換
          if [[ ! "$src" =~ ^/ ]]; then
            src="$(pwd)/$src"
          fi

          # srcパス(ファイルまたはディレクトリ)が存在する場合のみマウント
          if [ -e "$src" ]; then
            AI_MOUNT="$AI_MOUNT --mount type=bind,source=$src,target=$dst,bind-create-host-path=false"
            echo "mount: $src -> $dst"
          else
            echo "skip mount (not exists): $src"
          fi
        fi
      fi
    done < .aimount
  fi

  docker run -ti --rm \
    --stop-timeout 0 \
    --cap-add=NET_ADMIN \
    --cap-add=NET_RAW \
    --mount type=bind,source="$(pwd)",target=/workspace \
    --mount type=tmpfs,target=/workspace/.claude.local,tmpfs-size=0 \
    --mount type=bind,source="$(pwd)/.claude.local/.claude",target=/home/ubuntu/.claude \
    --mount type=bind,source="$(pwd)/.claude.local/.claude.json",target=/home/ubuntu/.claude.json \
    $AI_IGNORE \
    $AI_MOUNT \
    yumayo-ai \
    bash -ci "claude --dangerously-skip-permissions"
}
