#!/bin/bash

# 1つのエントリーをAI_IGNOREに追加
add_ignore_entry() {
  local host_path="$1"
  local container_path="$2"
  local message="$3"

  if [ -d "$host_path" ]; then
    AI_IGNORE="$AI_IGNORE \\
    --mount type=tmpfs,target=$container_path,tmpfs-size=0"
    echo "ignored: $message"
  elif [ -f "$host_path" ]; then
    AI_IGNORE="$AI_IGNORE \\
    --mount type=bind,source=/dev/null,target=$container_path,readonly"
    echo "ignored: $message"
  fi
}

# .aiignoreファイルを処理（base_dirとmount_dstを指定）
process_aiignore_file() {
  local aiignore_file="$1"
  local base_dir="$2"
  local mount_dst="$3"

  echo "found .aiignore: $aiignore_file"

  local aiignore_dir="$(dirname "$aiignore_file")"

  while IFS= read -r line || [ -n "$line" ]; do
    line="${line%$'\r'}"

    # 空行とコメント行をスキップ
    [ -z "$line" ] && continue
    [[ "$line" =~ ^[[:space:]]*# ]] && continue

    # パスの正規化
    line="${line#/}"
    local host_full_path="$aiignore_dir/$line"

    # マウント先でのパスを計算
    local rel_path="${host_full_path#$base_dir}"
    rel_path="${rel_path#/}"
    local container_path="$mount_dst/$rel_path"

    add_ignore_entry "$host_full_path" "$container_path" "$container_path"
  done < "$aiignore_file"
}

# ディレクトリ内の.aiignoreを再帰的に処理
find_and_process_aiignores() {
  local src_dir="$1"
  local mount_dst="$2"

  while read -r aiignore_file; do
    process_aiignore_file "$aiignore_file" "$src_dir" "$mount_dst"
  done < <(find "$src_dir" -name .aiignore -type f)
}

aicontainer() {
  mkdir -p .claude.local
  [ ! -f .claude.local/.claude.json ] && echo '{}' > .claude.local/.claude.json || true
  mkdir -p .claude.local/.claude

  AI_IGNORE=""

  # ルートの.aiignoreを処理
  if [ -f .aiignore ]; then
    while IFS= read -r line || [ -n "$line" ]; do
      line="${line%$'\r'}"
      [ -z "$line" ] && continue
      [[ "$line" =~ ^[[:space:]]*# ]] && continue

      line="${line#/}"
      add_ignore_entry "$line" "/workspace/$line" "/workspace/$line"
    done < .aiignore
  fi

  AI_MOUNT=""

  # .aimountを処理
  if [ -f .aimount ]; then
    while IFS= read -r line || [ -n "$line" ]; do
      line="${line%$'\r'}"
      [ -z "$line" ] && continue
      [[ "$line" =~ ^[[:space:]]*# ]] && continue

      IFS=':' read -r src dst <<< "$line"
      [ -z "$src" ] || [ -z "$dst" ] && continue

      # 相対パスを絶対パスに変換
      [[ ! "$src" =~ ^/ ]] && src="$(pwd)/$src"

      if [ ! -e "$src" ]; then
        echo "skip mount (not exists): $src"
        continue
      fi

      AI_MOUNT="$AI_MOUNT \\
    --mount type=bind,source=$src,target=$dst"
      echo "mount: $src -> $dst"

      # マウント元ディレクトリ内の.aiignoreを処理
      [ -d "$src" ] && find_and_process_aiignores "$src" "$dst"
    done < .aimount
  fi

  # 引数チェック
  local dump_mode=false
  local cmd="claude --dangerously-skip-permissions"

  if [ "$1" = "dump" ]; then
    dump_mode=true
  elif [ -n "$1" ]; then
    cmd="$1"
  fi

  # dockerコマンドを構築
  local docker_cmd="docker run -ti --rm \\
    --stop-timeout 0 \\
    --cap-add=NET_ADMIN \\
    --cap-add=NET_RAW \\
    --mount type=bind,source=\"$(pwd)\",target=/workspace \\
    --mount type=tmpfs,target=/workspace/.claude.local,tmpfs-size=0 \\
    --mount type=bind,source=\"$(pwd)/.claude.local/.claude\",target=/home/ubuntu/.claude \\
    --mount type=bind,source=\"$(pwd)/.claude.local/.claude.json\",target=/home/ubuntu/.claude.json$AI_MOUNT$AI_IGNORE \\
    yumayo-ai \\
    bash -ci \"$cmd\""

  if [ "$dump_mode" = true ]; then
    echo "$docker_cmd"
  else
    eval "$docker_cmd"
  fi
}
